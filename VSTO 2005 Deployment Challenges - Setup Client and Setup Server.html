<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>VSTO 2005 Deployment Challenges - Setup Client and Setup Server</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/mszCool [mario]' target='_blank'>mszCool [mario]</a>
<time>    3/17/2006 11:24:00 AM</time>
<hr>
<div id='content'><P><FONT face=Verdana size=2>This is a little follow-up from the VSTO workshop I did in Denmark on February 23rd and 24th. The two big questions I got of course where about deploying VSTO 2005 solutions:</FONT></P>
<UL>
<LI><FONT face=Verdana size=2>How can we setup client-security for our solutions?</FONT> 
<LI><FONT face=Verdana size=2>When using Visual Studio 2005 to publish, in many cases developer have to prepare publishing directories on their developer machines and then just copy them to product servers for their customers. But when publishing with Visual Studio on the developer machine, all the manifests point to the location on the local machine. How can we fix that?</FONT></LI></UL>
<P><FONT face=Verdana size=2>Finally I have created a sample project demonstrating the capabilities of the Code Access Security object model to perform client side deployment and the capabilities of the ServerDocument for deployment on the server-side with updating deployment manifest locations in the documents.</FONT></P>
<P><FONT face=Verdana size=2><STRONG><FONT color=#ff0000>WARNING:</FONT></STRONG></FONT></P>
<P><FONT face=Verdana size=2>For simplicity I have implemented all in Windows Forms applications which need to be launched manually. Of course all I did in the Windows Forms application usually needs to be done in an MSI installer package (you simply create a setup project with Visual Studio 2005 and then create a custom Installer class just by selecting "Add New Item" - "Installer Class" which then will contain the code I have just used in the Windows Forms application). </FONT></P>
<P><EM><FONT face=Verdana size=2>So rather think of these Windows Forms tools as MSI packages you create for your solution and one MSI package needs to be installed on the server and the other one needs to be installed on the client.</FONT></EM></P>
<P><STRONG><FONT face=Verdana size=2>Server Side Deployment Package</FONT></STRONG></P>
<P><FONT face=Verdana size=2>To use the VSTO.ServerInstallTool you just publish the VSTO solution with Visual Studio 2005 to your local developer machine. Then you copy and paste the directory with the files created by the Visual Studio deployment wizard to the destination server in the destination directory and call my tool. The tool needs to be ran on the production server and wants you to enter the physical directory on the production server, the name of the virtual directory (only the relative name) and the file name of the application manifest (usually in the root directory of the published directory created by the Visual Studio 2005 publish wizard). Actually the tool does nothing else than iterating through the directory hiearchy and updating manifests for XLS and DOC files:</FONT></P><FONT face=Verdana size=2><FONT color=#0000ff size=4>
<P><FONT size=1>private</FONT></FONT><FONT size=1> <FONT color=#0000ff>void</FONT> ProcessDirectory(<FONT color=#0000ff>string</FONT> fullPath)<BR>{<BR></FONT><FONT size=1><FONT color=#0000ff>&nbsp; try<BR>&nbsp; </FONT>{<BR></FONT><FONT size=1><FONT color=#008000>&nbsp;&nbsp;&nbsp; // Update manifests in all word documents or excel <BR>&nbsp;&nbsp;&nbsp; // workbooks<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008080>DirectoryInfo</FONT> di = <FONT color=#0000ff>new</FONT> <FONT color=#008080>DirectoryInfo</FONT>(fullPath);<BR>&nbsp;&nbsp;&nbsp; <FONT color=#008080>FileInfo</FONT>[] AllFiles = di.GetFiles();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>foreach</FONT> (<FONT color=#008080>FileInfo</FONT> fi <FONT color=#0000ff>in</FONT> AllFiles)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>if</FONT> (fi.Extension.Contains(<FONT color=#800000>"xls"</FONT>) || fi.Extension.Contains(<FONT color=#800000>"doc"</FONT>))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; UpdateDocumentManifest(fi.FullName);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp; }<BR><BR>&nbsp;&nbsp;&nbsp; </FONT><FONT size=1><FONT color=#008000>// Now process the other sub directories<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008080>DirectoryInfo</FONT>[] SubDirs = di.GetDirectories();<BR>&nbsp;&nbsp;&nbsp; <FONT color=#0000ff>foreach</FONT> (<FONT color=#008080>DirectoryInfo</FONT> sdi <FONT color=#0000ff>in</FONT> SubDirs)<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProcessDirectory(sdi.FullName);<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR><FONT color=#0000ff>&nbsp; catch</FONT> (<FONT color=#008080>Exception</FONT> ex)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; LogText.AppendText(<FONT color=#0000ff>string</FONT>.Format(<FONT color=#800000>"\r\n!! Error processing {0} --&gt; {1}"</FONT>,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fullPath, ex.Message));<BR>&nbsp; }<BR>}</FONT></P><FONT color=#0000ff>
<P><FONT size=1>private</FONT></FONT><FONT size=1> <FONT color=#0000ff>void</FONT> UpdateDocumentManifest(<FONT color=#0000ff>string</FONT> documentPath)<BR>{<BR></FONT><FONT size=1><FONT color=#0000ff>&nbsp; try<BR></FONT>&nbsp; {<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp; if</FONT> (<FONT color=#008080>ServerDocument</FONT>.IsCustomized(documentPath))<BR>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogText.AppendText(<FONT color=#0000ff>string</FONT>.Format(<FONT color=#800000>"\r\n\r\nProcessing {0}..."</FONT>, documentPath));<BR><FONT color=#0000ff>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; using</FONT> (<FONT color=#008080>ServerDocument</FONT> doc = <FONT color=#0000ff>new</FONT> <FONT color=#008080>ServerDocument</FONT>(documentPath))<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogText.AppendText(<FONT color=#0000ff>string</FONT>.Format(<FONT color=#800000>"\r\n-) Old path: {0}"</FONT>,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; doc.AppManifest.DeployManifestPath));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; doc.AppManifest.DeployManifestPath = <FONT color=#0000ff>string</FONT>.Format(<FONT color=#800000>"{0}/{1}"</FONT>,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; DestinationUrl, AppManifestText.Text);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogText.AppendText(<FONT color=#0000ff>string</FONT>.Format(<FONT color=#800000>"\r\n-) New path: {0}"</FONT>,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; doc.AppManifest.DeployManifestPath));<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; doc.Save();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; doc.Close();<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogText.AppendText(<FONT color=#0000ff>string</FONT>.Format(<FONT color=#800000>"\r\nSuccessfully processed {0}..."</FONT>, documentPath));<BR>&nbsp;&nbsp;&nbsp; }<BR></FONT><FONT size=1><FONT color=#0000ff>&nbsp;&nbsp;&nbsp; else<BR></FONT>&nbsp;&nbsp;&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogText.AppendText(<FONT color=#0000ff>string</FONT>.Format(<FONT color=#800000>"\r\nDocument '{0}' is not customized!"</FONT>, documentPath));<BR>&nbsp;&nbsp;&nbsp; }<BR>&nbsp; }<BR><FONT color=#0000ff>&nbsp; catch</FONT> (<FONT color=#008080>Exception</FONT> ex)<BR>&nbsp; {<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; LogText.AppendText(<FONT color=#0000ff>string</FONT>.Format(<FONT color=#800000>"\r\n!! Error processing {0} --&gt; {1}"</FONT>,&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; documentPath, ex.Message));<BR>&nbsp; }<BR>}</FONT><FONT size=4></P></FONT></FONT><FONT face=Verdana size=2>
<P><STRONG><FONT face=Verdana size=2>Client Side Deployment Package</FONT></STRONG></P>
<P><FONT face=Verdana size=2>On the client actually <STRONG>only the Code Access Security Policy</STRONG> needs to be setup. In environments with Active Directory I'd definitely recommend using Active Directory Group Policies for deploying these Code Access Security Policies and put them into the Enterprise Policy Level of Code Access Security configuration. For that purpose you can fire up the "Microsoft .NET Framework Configuration 2.0" in your Administrative Tools, move to the "Runtime Security Policy" node, rigth click it and select "Create Deployment Package". This creates an MSI that you then can deploy through Active Directory Group Policies across clients in your domain.</FONT></P></FONT>
<P><FONT face=Verdana size=2>If no Active Directory is available, you need to provide your own MSI package. Actually using the package created the way above overwrites the complete configuration tree on the target machine. For single-machine installs or for "small" customers this is definitely not what you want. Therefore you must create a tool or MSI package that just creates (and when uninstalling, deletes) the nodes necessary for your single application (in this case VSTO application).</FONT></P>
<P><FONT face=Verdana size=2>This is exactly what my VSTO.ClientInstallTool in this example is doing. It takes the strong name identifier of the VSTO customization assembly you have created and adds it based on this strong name as full trust assembly to your local configuration. Furthermore it adds a trust entry for the document's location (which is the URL to the server where the document has been deployed to).</FONT></P>
<P><FONT face=Verdana size=2>The code leverages the Code Access Security Policy object model, as you can see:</FONT></P><FONT size=4>
<P></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff>private</FONT> <FONT color=#0000ff>void</FONT> CreateCodeGroupsCommand_Click(<FONT color=#0000ff>object</FONT> sender, <FONT color=#008080>EventArgs</FONT></FONT><FONT face=Verdana> e)<BR></FONT></FONT><FONT face=Verdana size=2>{<BR></FONT><FONT color=#0000ff><FONT face=Verdana size=2>&nbsp; try<BR></FONT></FONT><FONT face=Verdana size=2>&nbsp; {<BR>&nbsp;&nbsp;&nbsp; </FONT><FONT color=#008000><FONT face=Verdana size=2>// First of all extract the strong name from the assembly<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#008000><FONT face=Verdana size=2>// WARNING: this should only be executed on trusted assemblies<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#008000><FONT face=Verdana size=2>// This code is really supposed to be used in setup package creation, not in WinForms, <BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#008000><FONT face=Verdana size=2>// this is really just a sample to demonstrate code, that you would use in a setup project<BR>&nbsp;&nbsp;&nbsp; </FONT></FONT><FONT color=#008000><FONT face=Verdana size=2>// within Visual Studio in a trusted environment<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp; Assembly</FONT> Asm = <FONT color=#008080>Assembly</FONT></FONT><FONT face=Verdana>.LoadFrom(AssemblyPathText.Text);<BR></FONT></FONT><FONT size=2><FONT face=Verdana color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;AssemblyName</FONT><FONT face=Verdana> AsmName = Asm.GetName();<BR></FONT></FONT><FONT size=2><FONT face=Verdana color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>byte</FONT><FONT face=Verdana>[] StrongNameToken = AsmName.GetPublicKey();<BR><BR></FONT></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// No create the new code groups<BR></FONT></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Get the user's node in code access security configuration<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>System.Collections.</FONT><FONT face=Verdana><FONT color=#008080>IEnumerator</FONT> PolicyEnumerator =&nbsp;<FONT color=#008080><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SecurityManager</FONT></FONT><FONT face=Verdana>.PolicyHierarchy();<BR></FONT></FONT><FONT size=2><FONT face=Verdana color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>while</FONT><FONT face=Verdana> (PolicyEnumerator.MoveNext())<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>{<BR></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Get the current policy<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PolicyLevel</FONT> pl = (<FONT color=#008080>PolicyLevel</FONT></FONT><FONT face=Verdana>)PolicyEnumerator.Current;<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>if</FONT> (pl.Type == <FONT color=#008080>PolicyLevelType</FONT></FONT><FONT face=Verdana>.Machine)<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>{<BR></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Add the code groups to the user's level<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>CreatePolicyLevel(pl, StrongNameToken);<BR></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Inform the user<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox</FONT>.Show(<FONT color=#0000ff>this</FONT></FONT><FONT face=Verdana>,<BR></FONT></FONT><FONT size=2><FONT face=Verdana color=#800000><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>"Successfully created security configuration!"</FONT><FONT face=Verdana>,<BR></FONT></FONT><FONT size=2><FONT face=Verdana color=#800000><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>"Security Configuration Completed"</FONT><FONT face=Verdana>,<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBoxButtons</FONT>.OK, <FONT color=#008080>MessageBoxIcon</FONT></FONT><FONT face=Verdana>.Information);<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>}<BR></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>}<BR></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;</FONT>}<BR></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;</FONT>catch</FONT> (<FONT color=#008080>Exception</FONT></FONT><FONT face=Verdana> ex)<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;</FONT>{<BR></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;MessageBox</FONT>.Show(<FONT color=#800000>"Unable to create code groups on client: "</FONT></FONT><FONT face=Verdana> + ex.Message);<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;</FONT>}<BR></FONT><FONT face=Verdana size=2>}</FONT></P>
<P><FONT size=2><FONT face=Verdana><FONT color=#0000ff>private</FONT> <FONT color=#0000ff>void</FONT> CreatePolicyLevel(<FONT color=#008080>PolicyLevel</FONT> pl, <FONT color=#0000ff>byte</FONT></FONT><FONT face=Verdana>[] publicKey)<BR></FONT></FONT><FONT face=Verdana size=2>{<BR></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Get the full trust permission set<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;NamedPermissionSet</FONT> FullTrustSet = <FONT color=#0000ff>null</FONT></FONT><FONT face=Verdana>;<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>foreach</FONT> (<FONT color=#008080>NamedPermissionSet</FONT> nsp <FONT color=#0000ff>in</FONT></FONT><FONT face=Verdana> pl.NamedPermissionSets)<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>{<BR></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>if</FONT> (nsp.Name.Equals(<FONT color=#800000>"FullTrust"</FONT></FONT><FONT face=Verdana>))<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>{<BR></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>FullTrustSet = nsp;<BR></FONT><FONT size=2><FONT face=Verdana color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>break</FONT><FONT face=Verdana>;<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>}<BR></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>}<BR></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>if</FONT> (FullTrustSet == <FONT color=#0000ff>null</FONT></FONT><FONT face=Verdana>)<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>throw</FONT> <FONT color=#0000ff>new</FONT> <FONT color=#008080>Exception</FONT>(<FONT color=#800000>"Unable to find FullTrust permission set!"</FONT></FONT><FONT face=Verdana>);<BR><BR></FONT></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Create the code group for the strong name assembly<BR></FONT></FONT><FONT size=2><FONT face=Verdana color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;StrongNameMembershipCondition</FONT><FONT face=Verdana> SNMembership =&nbsp;<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>new</FONT> <FONT color=#008080>StrongNameMembershipCondition</FONT></FONT><FONT face=Verdana>(<BR></FONT></FONT><FONT face=Verdana><FONT size=2><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>new</FONT> <FONT color=#008080>StrongNamePublicKeyBlob</FONT>(publicKey), <FONT color=#0000ff>null</FONT>, <FONT color=#0000ff>null<BR></FONT></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>);<BR></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;PolicyStatement</FONT> PStmt = <FONT color=#0000ff>new</FONT> <FONT color=#008080>PolicyStatement</FONT>(FullTrustSet,<BR><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;PolicyStatementAttribute</FONT></FONT><FONT face=Verdana>.Exclusive);<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;UnionCodeGroup</FONT> AssemblyCodeGroup =<BR><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff>new</FONT> <FONT color=#008080>UnionCodeGroup</FONT></FONT><FONT face=Verdana>(SNMembership, PStmt);<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>AssemblyCodeGroup.Name = </FONT><FONT face=Verdana><FONT color=#800000>"mszCool_"</FONT> + <FONT color=#008080>Guid</FONT></FONT><FONT face=Verdana>.NewGuid().ToString();<BR><BR></FONT></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Create the code group for the document url<BR></FONT></FONT><FONT size=2><FONT face=Verdana color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;UrlMembershipCondition</FONT><FONT face=Verdana> UrlMembership =<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#0000ff><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT>new</FONT> <FONT color=#008080>UrlMembershipCondition</FONT></FONT><FONT face=Verdana>(ServerDocumentURL.Text);<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;PolicyStatement</FONT> DocPStmt = <FONT color=#0000ff>new</FONT> <FONT color=#008080>PolicyStatement</FONT>(FullTrustSet,&nbsp;<FONT color=#008080><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PolicyStatementAttribute</FONT></FONT><FONT face=Verdana>.Exclusive);<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;UnionCodeGroup</FONT> DocumentCodeGroup =&nbsp;<BR><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</FONT><FONT color=#0000ff>new</FONT> <FONT color=#008080>UnionCodeGroup</FONT></FONT><FONT face=Verdana>(UrlMembership, DocPStmt);<BR></FONT></FONT><FONT size=2><FONT face=Verdana><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>DocumentCodeGroup.Name = </FONT><FONT face=Verdana><FONT color=#800000>"mszCool_"</FONT> + <FONT color=#008080>Guid</FONT></FONT><FONT face=Verdana>.NewGuid().ToString();<BR><BR></FONT></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Add the code groups to the policy level<BR></FONT></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>pl.RootCodeGroup.AddChild(AssemblyCodeGroup);<BR></FONT><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>pl.RootCodeGroup.AddChild(DocumentCodeGroup);<BR><BR></FONT><FONT color=#008000><FONT face=Verdana size=2><FONT color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;</FONT>// Save the configuration<BR></FONT></FONT><FONT size=2><FONT face=Verdana color=#008080>&nbsp;&nbsp;&nbsp;&nbsp;SecurityManager</FONT><FONT face=Verdana>.SavePolicyLevel(pl);<BR></FONT></FONT><FONT face=Verdana size=2>}</FONT><FONT size=4></P></FONT>
<P><FONT face=Verdana><FONT size=2>Again, I'd really recommend putting this code into MSI packages which at the end is the exactly the same except that it is called from within an Installer class and that it either gets information from the user during setup or gets the information automatically within the build process of your application.</FONT></FONT></P>
<P><FONT face=Verdana><FONT size=2>The ServerDocument actually can be used for another nice use case: it is a really good mechanism&nbsp;for updating deployment locations in existing documents of your users. Finally with the two object models introduced in this blog post, you are ready to got for deploying VSTO based solutions. </FONT></FONT></P>
<P><FONT face=Verdana><FONT size=2><STRONG>I have added the samples in the ZIP file in the ATTACHMENT OF THIS POST. So if you want to take a closer look at the code, just download, extract and go for it.</STRONG></P></FONT></FONT>
<p><a href="media/MSDNBlogsFS/prod.evol.blogs.msdn.com/CommunityServer.Components.PostAttachments/00/00/55/38/15/VSTOTestDeploy.zip" original-url="http://blogs.msdn.com/cfs-file.ashx/__key/communityserver-components-postattachments/00-00-55-38-15/VSTOTestDeploy.zip">VSTOTestDeploy.zip</a></p></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
