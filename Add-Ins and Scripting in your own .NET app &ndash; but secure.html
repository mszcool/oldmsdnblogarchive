<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>Add-Ins and Scripting in your own .NET app &ndash; but secure</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/mszCool [mario]' target='_blank'>mszCool [mario]</a>
<time>    6/14/2004 11:17:00 PM</time>
<hr>
<div id='content'><P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="mso-ansi-language: EN-US"><FONT face=Arial>Many applications have the need of being extensible either through an add-in or a scripting mechanism. Technically both can be implemented very easy using the .NET framework at all:<?xml:namespace prefix = o ns = "urn:schemas-microsoft-com:office:office" /><o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 6pt 0cm 0pt 35.7pt; TEXT-INDENT: -17.85pt; tab-stops: list 36.0pt"><SPAN lang=EN-US style="FONT-FAMILY: Symbol; mso-ansi-language: EN-US; mso-fareast-font-family: Symbol; mso-bidi-font-family: Symbol">&#183;</SPAN><FONT face=Arial><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><SPAN style="mso-spacerun: yes">&nbsp; </SPAN></SPAN><SPAN lang=EN-US style="mso-ansi-language: EN-US">Supporting add-ins often means nothing else than supplying an interface that have to be implemented by an add-in and loading the add-in at runtime through Assembly.CreateInstance(type&#8230;).<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal style="MARGIN: 6pt 0cm 0pt 35.7pt; TEXT-INDENT: -17.85pt; tab-stops: list 36.0pt"><SPAN lang=EN-US style="FONT-FAMILY: Symbol; mso-ansi-language: EN-US; mso-fareast-font-family: Symbol; mso-bidi-font-family: Symbol">&#183;</SPAN><FONT face=Arial><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><SPAN style="mso-spacerun: yes">&nbsp; </SPAN></SPAN><SPAN lang=EN-US style="mso-ansi-language: EN-US">Even adding scripting support to your .NET application is not that hard if you have taken a look at CodeDOM (just take a look at a <A href="http://weblogs.asp.net/beatsch/archive/2004/05/08/128541.aspx">web cast</A> of my colleague <A href="http://weblogs.asp.net/beatsch">Beat</A>).<o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="FONT-FAMILY: 'Times New Roman'; mso-ansi-language: EN-US"><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="mso-ansi-language: EN-US"><FONT face=Arial>But very often as enthusiastic developers implementing this cool add-in or scripting mechanism we forget about security at all (or say, the danger of forgetting is high</FONT></SPAN><SPAN lang=EN-US style="FONT-FAMILY: Wingdings; mso-ansi-language: EN-US; mso-ascii-font-family: Arial; mso-hansi-font-family: Arial; mso-char-type: symbol; mso-symbol-font-family: Wingdings"><SPAN style="mso-char-type: symbol; mso-symbol-font-family: Wingdings">J</SPAN></SPAN><SPAN lang=EN-US style="mso-ansi-language: EN-US"><FONT face=Arial>). How can we ensure security in that case? Exactly that&#8217;s what I want to shortly right now.<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="FONT-FAMILY: 'Times New Roman'; mso-ansi-language: EN-US"><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="mso-ansi-language: EN-US"><FONT face=Arial>Basically, the answer is quite easy. Just load the assembly and types of the add-in (or the compiled script) into a separate application domain and <STRONG><I><SPAN style="FONT-FAMILY: Arial">restrict the security policy of this domain</SPAN></I></STRONG> to a minimum of required permissions. Take a look at the following code snippet:<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="FONT-FAMILY: 'Times New Roman'; mso-ansi-language: EN-US"><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><FONT face=Arial><SPAN lang=EN-US style="FONT-SIZE: 10pt; COLOR: blue; mso-ansi-language: EN-US">private</SPAN><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"> <SPAN style="COLOR: blue">void</SPAN> SetDomainPolicy(<SPAN style="COLOR: blue">ref</SPAN> AppDomain scriptDomain) <o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial>{<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN>PolicyLevel level = PolicyLevel.CreateAppDomainLevel();<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><o:p><FONT face=Arial>&nbsp;</FONT></o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN><SPAN style="COLOR: green">// Create a new permission set and add the permission set to the policy level<o:p></o:p></SPAN></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><FONT face=Arial><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><SPAN style="mso-spacerun: yes">&nbsp; </SPAN><B style="mso-bidi-font-weight: normal">PermissionSet scriptSet = <SPAN style="COLOR: blue">new</SPAN> PermissionSet(PermissionState.None);</B></SPAN><SPAN style="FONT-FAMILY: 'Times New Roman'"><o:p></o:p></SPAN></FONT></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><B style="mso-bidi-font-weight: normal">scriptSet.AddPermission(<SPAN style="COLOR: blue">new</SPAN> FileIOPermission(<o:p></o:p></B></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><B style="mso-bidi-font-weight: normal">FileIOPermissionAccess.Read, @"E:\Workshop"));<o:p></o:p></B></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN><B style="mso-bidi-font-weight: normal">scriptSet.AddPermission(<SPAN style="COLOR: blue">new</SPAN> System.Security.Permissions.SecurityPermission(<o:p></o:p></B></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><B style="mso-bidi-font-weight: normal">SecurityPermissionFlag.Execution | <o:p></o:p></B></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </SPAN><B style="mso-bidi-font-weight: normal">SecurityPermissionFlag.SkipVerification));<o:p></o:p></B></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><o:p><FONT face=Arial>&nbsp;</FONT></o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN><SPAN style="COLOR: green">// Add a policy statement<o:p></o:p></SPAN></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN>PolicyStatement stmt = <SPAN style="COLOR: blue">new</SPAN> PolicyStatement(scriptSet);<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN>CodeGroup group = <SPAN style="COLOR: blue">new</SPAN> UnionCodeGroup(<SPAN style="COLOR: blue">new</SPAN> AllMembershipCondition(), stmt);<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN>level.RootCodeGroup = group;<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; COLOR: green; mso-ansi-language: EN-US"><o:p><FONT face=Arial>&nbsp;</FONT></o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN><SPAN style="COLOR: green">// Apply the policy level<o:p></o:p></SPAN></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt; mso-layout-grid-align: none"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial><SPAN style="mso-spacerun: yes">&nbsp; </SPAN>scriptDomain.SetAppDomainPolicy(level);<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="FONT-SIZE: 10pt; mso-ansi-language: EN-US"><FONT face=Arial>}<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="FONT-FAMILY: 'Times New Roman'; mso-ansi-language: EN-US"><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="mso-ansi-language: EN-US"><FONT face=Arial>This function just gets a reference to the application domain previously created through <I style="mso-bidi-font-style: normal">AppDomain.CreateDomain</I> and sets the code access security policies to this application domain manually. After you have set those policies through <I style="mso-bidi-font-style: normal">SetAppDomainPolicy</I> you can load new types and assemblies into the app domain running with the restricted set of permissions.<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="FONT-FAMILY: 'Times New Roman'; mso-ansi-language: EN-US"><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="mso-ansi-language: EN-US"><FONT face=Arial>Another important point here is that the add-in or script is not able to perform critical actions by itself &#8211; it is the task of the host application to provide an appropriate object model to the add-in / script through which it can do call-backs into the host application for performing some critical actions. Therefore the host application perhaps has to perform some <I style="mso-bidi-font-style: normal">asserts</I> on permissions the add-in / script does not have to avoid leading up in security exceptions (remember: stack walk and don&#8217;t forget to revert all asserts in your host application). You can find examples for assert on our local community web page </FONT><A href="http://www.dotnetexperts.at/"><FONT face=Arial>www.dotnetexperts.at</FONT></A><FONT face=Arial> within the article for </FONT><A href="http://www.dotnetexperts.at/default.aspx?cid=8e47a5db-6802-48fc-9d1b-2ca199dd45cc"><FONT face=Arial>demos-download of our security road show</FONT></A><FONT face=Arial>.<o:p></o:p></FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="FONT-FAMILY: 'Times New Roman'; mso-ansi-language: EN-US"><o:p>&nbsp;</o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="mso-ansi-language: EN-US"><FONT face=Arial>What I have found very interesting with this is the existence of <EM><B><SPAN style="FONT-FAMILY: Arial">a whole object model for code access security</SPAN></B></EM>. You even can refer to configured code groups and permission sets with this object model or create new ones without touching the .NET Framework Security Tool or caspol.exe anyway.&nbsp;I think&nbsp;I will focus on exactly this object model with my following blog entries&#8230;</FONT></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="mso-ansi-language: EN-US"><o:p><FONT face=Arial>&nbsp;</FONT></o:p></SPAN></P>
<P class=MsoNormal style="MARGIN: 0cm 0cm 0pt"><SPAN lang=EN-US style="mso-ansi-language: EN-US"><FONT face=Arial>You can find a detailed description of the things I have described above in the book &#8220;</FONT><A href="http://www.amazon.com/exec/obidos/tg/detail/-/067232184X/qid=1087247178/sr=1-1/ref=sr_1_1/103-3937208-7477424?v=glance&amp;s=books"><FONT face=Arial>.NET Framework Security</FONT></A><FONT face=Arial>&#8221; which is in my opinion a very good reference but not a book for reading from the beginning to the end at once.<o:p></o:p></FONT></SPAN></P></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
