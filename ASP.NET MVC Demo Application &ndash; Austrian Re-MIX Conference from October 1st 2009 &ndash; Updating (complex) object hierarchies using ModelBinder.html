<html><head>
<meta charset='UTF-8'>
<link href='resource/bootstrap.min.css' rel='Stylesheet' type='text/css' />
<link href='resource/style.css' rel='Stylesheet' type='text/css' />
</head>
<body>
<div id='page'>
<h1 class='entry-title'>ASP.NET MVC Demo Application &ndash; Austrian Re-MIX Conference from October 1st 2009 &ndash; Updating (complex) object hierarchies using ModelBinder</h1>
 <a class='url fn n profile-usercard-hover' href='https://social.msdn.microsoft.com/profile/mszCool [mario]' target='_blank'>mszCool [mario]</a>
<time>    10/2/2009 12:17:16 PM</time>
<hr>
<div id='content'><p>Yesterday we had our Austrian version of the Re-MIX conference in the Hilton Hotel at Stadtpark in Vienna. It was a great conference combined with a superb architect forum together with Simon Guest, who unveiled his thoughts on cloud computing… but more on that in a separate post, this one is about the ASP.NET MVC session I delivered in the late afternoon in the web dev track!</p>  <p><strong><u>An ASP.NET MVC Walkthrough &amp; Updating object hierarchies…</u></strong></p>  <p>In my session “Introducing the ASP.NET MVC Web Development Framework” inspired by <a href="http://haacked.com/">Phil Haack’s</a> session at the last MIX-conference I demonstrated, what development with the ASP.NET MVC framework looks like.</p>  <p align="center"><strong><font size="4"><a href="http://www.mszcool.at/blog/2009/20091001-RemixDemoApp.zip">Download the sample here</a></font></strong></p>  <p align="center"><strong><font size="4"><a href="http://www.mszcool.at/blog/2009/20091001-Remix_ASPNET_MVC_Session.pptx">Download the slides here</a></font></strong></p>  <p>In the session I created a simple application for displaying, modifying and adding events with event deliveries, from scratch. The following graphic shows the entity data model we’ve been working with:</p>  <p><a href="media/TNBlogsFS/BlogFileStorage/blogs_msdn/mszcool/WindowsLiveWriter/ASP.NETMVCDemoApplicationAustrianReMIXCo_FBA7/image_2.png" original-url="http://blogs.msdn.com/blogfiles/mszcool/WindowsLiveWriter/ASP.NETMVCDemoApplicationAustrianReMIXCo_FBA7/image_2.png"><img style="border-bottom: 0px; border-left: 0px; display: inline; border-top: 0px; border-right: 0px" title="image" border="0" alt="image" src="media/TNBlogsFS/BlogFileStorage/blogs_msdn/mszcool/WindowsLiveWriter/ASP.NETMVCDemoApplicationAustrianReMIXCo_FBA7/image_thumb.png" original-url="http://blogs.msdn.com/blogfiles/mszcool/WindowsLiveWriter/ASP.NETMVCDemoApplicationAustrianReMIXCo_FBA7/image_thumb.png" width="421" height="252" /></a> </p>  <p>As you can see, a single Event has multiple deliveries at different locations. While implementing the controller actions for adding new events and modifying existing events I was challenged by the question, “how the model binder updates object hierarchies”. And the point is – it doesn’t, automatically…</p>  <p>Based on <a href="http://haacked.com/archive/2008/10/23/model-binding-to-a-list.aspx">Phil Haack’s tip on binding collections on his blog</a> and based on <a href="http://goneale.com/2009/07/27/updating-multiple-child-objects-and-or-collections-in-asp-net-mvc-views/">a posting from Graham O’Neale here</a> I completed my idea in this example. Below are the steps for combining the concepts from the previously mentioned blog entries:</p>  <p><strong>1.) In my views for Editing and Adding events, add HTML and script - a table that will be dynamically expanded with new items through JavaScript for each new child-item I want to create (event delivery in my case – the parts in red are the important ones in the view):</strong></p>  <p><font size="2" face="Consolas">&lt;fieldset&gt;     <br />&#160;&#160;&#160; &lt;legend&gt;Fields&lt;/legend&gt;      <br />&#160;&#160;&#160; &lt;p&gt;      <br />&#160;&#160;&#160;&#160; &lt;label for=&quot;Title&quot;&gt;Title:&lt;/label&gt;      <br />&#160;&#160;&#160;&#160; &lt;%= Html.TextBox(&quot;Title&quot;) %&gt;      <br />&#160;&#160;&#160;&#160; &lt;%= Html.ValidationMessage(&quot;Title&quot;, &quot;*&quot;) %&gt;      <br />&#160;&#160;&#160; &lt;/p&gt;      <br />&#160;&#160;&#160; &lt;p&gt;      <br />&#160;&#160;&#160;&#160; &lt;label for=&quot;Description&quot;&gt;Description:&lt;/label&gt;      <br />&#160;&#160;&#160;&#160; &lt;%= Html.TextBox(&quot;Description&quot;) %&gt;      <br />&#160;&#160;&#160;&#160; &lt;%= Html.ValidationMessage(&quot;Description&quot;, &quot;*&quot;) %&gt;      <br />&#160;&#160;&#160; &lt;/p&gt;      <br />&lt;/fieldset&gt; </font></p>  <p><font size="2"><font face="Consolas"><strong><font color="#ff0000">&lt;table id=&quot;DeliveryTable&quot;&gt;           <br />&#160;&#160;&#160; &lt;tr&gt;            <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;th&gt;            <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Delivery Begin Date            <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/th&gt;            <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;th&gt;            <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Delivery End Date            <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/th&gt;            <br />&#160;&#160;&#160; &lt;/tr&gt;            <br />&lt;/table&gt;</font></strong> </font></font></p>  <p><font size="2" face="Consolas">&lt;p&gt;     <br /></font><strong><font color="#ff0000" size="2" face="Consolas">&#160;&#160;&#160; &lt;input type=&quot;button&quot; value=&quot;Add Delivery&quot;        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></strong><font size="2"><font face="Consolas"><strong><font color="#ff0000">onclick=&quot;javascript:AddDelivery()&quot; /&gt;</font></strong> &lt;br /&gt;        <br />&#160;&#160;&#160; &lt;input type=&quot;submit&quot; value=&quot;Create&quot; /&gt;        <br />&lt;/p&gt; </font></font></p>  <p><font color="#ff0000" size="2" face="Consolas"><strong>&lt;script type=&quot;text/javascript&quot; language=&quot;javascript&quot;&gt; </strong></font></p>  <p><font color="#ff0000" size="2" face="Consolas"><strong>function AddDelivery() { </strong></font></p>  <p><strong><font color="#ff0000" size="2" face="Consolas">&#160;&#160;&#160; // Add a row to the table       <br />&#160;&#160;&#160; var DeliveryTableBody =&#160; <br />&#160;&#160;&#160;&#160; document.getElementById</font></strong><font color="#ff0000" size="2" face="Consolas"><strong>(       <br />&#160;&#160;&#160;&#160;&#160; &quot;DeliveryTable&quot;).getElementsByTagName(        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;tbody&quot;).item(0);        <br />&#160;&#160;&#160; var ItemCount =         <br />&#160;&#160;&#160;&#160;&#160;&#160; DeliveryTableBody.childNodes.length - 1; </strong></font></p>  <p><font color="#ff0000" size="2" face="Consolas"><strong>&#160;&#160;&#160; var newChild = document.createElement(&quot;tr&quot;);       <br />&#160;&#160;&#160; var col1 = document.createElement(&quot;td&quot;);        <br />&#160;&#160;&#160; col1.innerHTML =&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;&lt;input type='text'&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; name='Event.Deliveries[&quot;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; + ItemCount + &quot;].BeginDate' /&gt;&quot;;        <br />&#160;&#160;&#160; var col2 = document.createElement(&quot;td&quot;);        <br />&#160;&#160;&#160; col2.innerHTML = &quot;&lt;input type='text'&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; name='Event.Deliveries[&quot; + ItemCount +&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;].EndDate' /&gt;&quot;;        <br />&#160;&#160;&#160; newChild.appendChild(col1);        <br />&#160;&#160;&#160; newChild.appendChild(col2);        <br />&#160;&#160;&#160; DeliveryTableBody.appendChild(newChild);        <br />} </strong></font></p>  <p><font color="#ff0000" size="2" face="Consolas"><strong>&lt;/script&gt;</strong></font></p>  <p><strong>2.) In my action method for adding events in the EventController I simply was required to update the signature of the action-method with the Form-postback-collection and a separate call to update model as shown below:</strong></p>  <p><font size="2" face="Consolas">[Authorize]     <br />[AcceptVerbs(HttpVerbs.Post)]      <br />public ActionResult Add(      <br />&#160;&#160;&#160;&#160;&#160;&#160; [Bind(Exclude=&quot;EventId&quot;)] Event ev, </font><strong><font color="#ff0000">       <br /><font size="2" face="Consolas">&#160;&#160;&#160;&#160;&#160;&#160; FormCollection postValues</font></font></strong><font size="2" face="Consolas">)     <br />{      <br />&#160;&#160;&#160; //      <br />&#160;&#160;&#160; // Validate incoming stuff      <br />&#160;&#160;&#160; //      <br />&#160;&#160;&#160; if (string.IsNullOrEmpty(ev.Title))      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; ModelState.AddModelError(&quot;Title&quot;,       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><font size="2" face="Consolas">&quot;Title cannot be empty!&quot;);     <br />&#160;&#160;&#160; if (string.IsNullOrEmpty(ev.Description))      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; ModelState.AddModelError(&quot;Description&quot;,       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;Please enter a description for your event!&quot;);      <br />&#160;&#160;&#160; //       <br />&#160;&#160;&#160; // Validation succeeded?       <br />&#160;&#160;&#160; // If yes, add the event, otherwise       <br />&#160;&#160;&#160; // return to the view      <br />&#160;&#160;&#160; //      <br />&#160;&#160;&#160; if (ModelState.IsValid)      <br />&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; DataContext.AddToEvent(ev);      <br />&#160;</font><font size="2"><font face="Consolas"><strong><font color="#ff0000">&#160;&#160;&#160;&#160;&#160;&#160; UpdateModel&lt;IEnumerable&lt;EventDelivery&gt;&gt;(           <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ev.Deliveries, &quot;Event.Deliveries&quot;);            <br /></font></strong>&#160;&#160;&#160;&#160;&#160;&#160;&#160; DataContext.SaveChanges(); </font></font></p>  <p><font size="2" face="Consolas">&#160;&#160;&#160;&#160;&#160;&#160;&#160; return RedirectToAction(&quot;Index&quot;);     <br />&#160;&#160;&#160; }      <br />&#160;&#160;&#160; else      <br />&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return View();      <br />&#160;&#160;&#160; }      <br />}</font></p>  <p><strong>3.) When modifying existing items, the whole thing gets more tricky when working with the ADO.NET Entity Framework. Why? Simply because the ASP.NET MVC default model binder, when updating collections, unfortunately clears them and re-fills them with the items posted back in the Form postback-collection. That breaks the ADO.NET Entity Framework association set (the ASP.NET MVC model binder does not know about associations). Now you have two possibilities, either modify the source code of ASP.NET MVC (if possible I would stay with the thing as it gets delivered) or apply a little trick as I did. I just created a temporary Event, filled it from scratch with the postback-parameters and then copied the values to the existing and to new items as below. Of course the whole thing needs refinement (especially when mapping to existing items in collections), but I think it’s at least a starting point!</strong></p>  <p><font size="2" face="Consolas">[Authorize]     <br />[AcceptVerbs(HttpVerbs.Post)]      <br />public ActionResult Edit(int eventId,       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font><font size="2"><font face="Consolas"><strong><font color="#ff0000">FormCollection postValues</font></strong>)        <br />{        <br />&#160;&#160;&#160; Event CurrentEvent =&#160; <br />&#160;&#160;&#160; (from e in DataContext.Event.Include(&quot;Deliveries&quot;)        <br />&#160;&#160;&#160;&#160; where e.EventId == eventId        <br />&#160;&#160;&#160;&#160; select e).FirstOrDefault(); </font></font></p>  <p><font size="2" face="Consolas">&#160;&#160;&#160; if (CurrentEvent != null)     <br />&#160;&#160;&#160; {      <br /></font><font size="2"><font face="Consolas"><strong><font color="#ff0000">&#160;&#160;&#160;&#160;&#160;&#160;&#160; Event Temp = new Event();           <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; UpdateModel(Temp, &quot;Event&quot;,&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; new string[] { &quot;Title&quot;,             <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;Description&quot; });            <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; UpdateModel(Temp.Deliveries,&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;Event.Deliveries&quot;,&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; new string[] { &quot;BeginDate&quot;,             <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &quot;EndDate&quot; });            <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; CopyEvent(CurrentEvent, Temp);</font></strong> </font></font></p>  <p><font size="2" face="Consolas">&#160;&#160;&#160;&#160;&#160;&#160;&#160; DataContext.SaveChanges(); </font></p>  <p><font size="2" face="Consolas">&#160;&#160;&#160;&#160;&#160;&#160;&#160; return RedirectToAction(&quot;Index&quot;);     <br />&#160;&#160;&#160; }      <br />&#160;&#160;&#160; else      <br />&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; ModelState.AddModelError(&quot;General&quot;, &quot;...&quot;);      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return View();      <br />&#160;&#160;&#160; }      <br />}</font></p>  <p>I hope that’s a helpful posting for anyone who’s facing the same challenges when working with MVC:) Nevertheless, for those who want to have full control over HTML and want to have better testing possibilities, this framework is the right choice. If you’re rather the “productivity-kind-of-developer”, sticking with web forms might be the more convenient solution...</p></div>
</div></body>
<script type='text/javascript' src='resource/jquery-1.12.1.min.js'></script>
<script type='text/javascript' src='resource/replace.js'></script>
</html>
